---
title: "Results_last_call"
author: "Vitória"
date: '2023-05-17'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(qvalue)
library(knitr)
```

```{r get_data, echo=FALSE, warning = FALSE, message = FALSE}
NE_table <- fread("/dados/time_clines/data/seqs/align/NE_no_ESC97_mincount5_minfreq0.001_cov15.tsv")
SNPs_97_cov15 <- fread("/dados/time_clines/output/SNPs/p-values_97_no_ESC97_mincount5_minfreq0.001_cov15.tsv")
SNPs_0910_cov15 <- fread("/dados/time_clines/output/SNPs/p-values_0910_no_ESC97_mincount5_minfreq0.001_cov15.tsv")
inv_freq <- fread("/dados/vitoria/invertions_freqs/PoolSNP_no_ESC97_mincount5_minfreq0.001_cov15_inversion.freq")
seq_metadata <- read_tsv("/home/vitoria/clinas/seq_metadata.tsv")

```

## PCA 
```{r wragle_pca_data, echo=FALSE}
all_samples <- NE_table[, .(population, CHROM, POS, freq)]
all_samples[, position2 := paste(CHROM, POS, sep = ":")]
all_samples <- all_samples[, !c("CHROM", "POS")]
pre_pca_table <- dcast.data.table(all_samples, position2 ~ population,
                 value.var = "freq")

pop_info <- seq_metadata %>%
  select(population, collection_year, latitude)

```

### 1997
```{r PCA97, echo=FALSE}
pre_pca_table97 <- pre_pca_table[, !(names(pre_pca_table) %like% "09" | names(pre_pca_table) %like% "10" | names(pre_pca_table) %like% "17"),
                                 with = FALSE]

no_NA_table97 <- na.omit(pre_pca_table97)

pca_table97 <- no_NA_table97 %>%
  column_to_rownames(var = "position2")

pca_table97 <- t(pca_table97)

pca97 <- prcomp(pca_table97)

#gets the percentage of variation that each PC accounts
pca_var97 <- pca97$sdev^2
pca_var_per97 <- round(pca_var97/sum(pca_var97)*100, 1)

#joins all info in a single table
graph_table97 <- tibble(population = rownames(pca97$x), 
                      pc1 = pca97$x[,1], #gets the first four PCs
                      pc2 = pca97$x[,2],
                      pc3 = pca97$x[,3],
                      pc4 = pca97$x[,4]) %>% 
  inner_join(pop_info, by = "population") %>%  #joins tables
  mutate(collection_year = as.character(collection_year))


#plot colored by latitude
graph_table97 %>%
  ggplot(aes(x = pc1, y = pc2)) +
  geom_point(aes(color = latitude), size = 4, alpha = 0.5) +
  scale_color_viridis_c() +
  geom_text(aes(label = population), size = 1.5, nudge_y = 10) +
  xlab(paste("PC1 - ", pca_var_per97[1], "%", sep = "")) +
  ylab(paste("PC2 - ", pca_var_per97[2], "%", sep = "")) +
  theme_bw()

```

### 2009/2010
```{r PCA0910, echo=FALSE}
pre_pca_table0910 <- pre_pca_table[, !(names(pre_pca_table) %like% "97" | names(pre_pca_table) %like% "17"),
                                 with = FALSE]

no_NA_table0910 <- na.omit(pre_pca_table0910)

pca_table0910 <- no_NA_table0910 %>%
  column_to_rownames(var = "position2")

pca_table0910 <- t(pca_table0910)

pca0910 <- prcomp(pca_table0910)

#gets the percentage of variation that each PC accounts
pca_var0910 <- pca0910$sdev^2
pca_var_per0910 <- round(pca_var0910/sum(pca_var0910)*100, 1)

#joins all info in a single table
graph_table0910 <- tibble(population = rownames(pca0910$x), 
                        pc1 = pca0910$x[,1], #gets the first four PCs
                        pc2 = pca0910$x[,2],
                        pc3 = pca0910$x[,3],
                        pc4 = pca0910$x[,4]) %>% 
  inner_join(pop_info, by = "population") %>%  #joins tables
  mutate(collection_year = as.character(collection_year))


#plot colored by latitude
graph_table0910 %>%
  ggplot(aes(x = pc1, y = pc2)) +
  geom_point(aes(color = latitude), size = 4, alpha = 0.5) +
  scale_color_viridis_c() +
  geom_text(aes(label = population), size = 1.5, nudge_y = 10) +
  xlab(paste("PC1 - ", pca_var_per0910[1], "%", sep = "")) +
  ylab(paste("PC2 - ", pca_var_per0910[2], "%", sep = "")) +
  theme_bw()

```

## ConStruct
### 1997 
```{r conStruct_97, echo=FALSE}
knitr::include_graphics("../ConStruct/StructurePlot_k2_FR_ZI_NA_97.png")
```

Modelo espacial à esquerda e não espacial à direita. Amostra da Zambia é sempre a mais a esquerda; a amostra da França é sempre a mais a direita

### 2009/2010
```{r conStruct_0910, echo=FALSE}
knitr::include_graphics("../ConStruct/StructurePlot_k2_FR_ZI_NA_0910.png")
```

Modelo espacial à esquerda e não espacial à direita. Amostra da Zambia é sempre a mais a esquerda; a amostra da França é sempre a mais a direita

## PCA per chrom
### 1997
```{r pca_per_chrom_97, echo=FALSE, message=FALSE, warning=FALSE}
chroms <- c("2L", "2R", "3L", "3R", "X")
no_NA_table97[, c("CHROM", "POS") := tstrsplit(position2, ":", fixed = TRUE)]

#separate each chrom
output <- vector("list", length = length(chroms))
for (i in seq_along(chroms)) {
  output[[i]] <- no_NA_table97[CHROM == chroms[[i]],][, !c("CHROM", "POS")]
}

#pre pca and pca
for (i in seq_along(output)) {
  output[[i]] <- column_to_rownames(output[[i]], var = "position2")
}

for (i in seq_along(output)) {
  output[[i]] <- t(output[[i]])
}

pca_per_chrom <- vector("list", length = length(chroms))
for (i in seq_along(output)) {
  pca_per_chrom[[i]] <- prcomp(output[[i]])
}

#gets pc1 and 2 for each chrom
pcs1e2_per_chrom <- vector("list", length = length(chroms))
for (i in seq_along(pca_per_chrom)) {
  pcs1e2_per_chrom[[i]] <- pca_per_chrom[[i]]$x[,1:2]
}

for (i in seq_along(pcs1e2_per_chrom)) {
  pcs1e2_per_chrom[[i]] <- as.data.frame(pcs1e2_per_chrom[[i]])
}

#change cols names
for (i in seq_along(pcs1e2_per_chrom)) {
  pcs1e2_per_chrom[[i]] <- setnames(pcs1e2_per_chrom[[i]],
                                    colnames(pcs1e2_per_chrom[[i]]),
                                    paste(colnames(pcs1e2_per_chrom[[i]]), chroms[[i]], sep = "_"))
}

all_chrom_pcs1e2 <- reduce(pcs1e2_per_chrom, cbind) %>%
  rownames_to_column("population")

#gets sdv per chrom
sdv_per_chrom <- vector("list", length = length(pca_per_chrom))
for (i in seq_along(pca_per_chrom)) {
  sdv_per_chrom[[i]] <- (pca_per_chrom[[i]]$sdev)^2
}

for (i in seq_along(sdv_per_chrom)) {
  sdv_per_chrom[[i]] <- round((sdv_per_chrom[[i]]/sum(sdv_per_chrom[[i]]))*100, 1)
}

sd_pcs_per_chrom <- reduce(sdv_per_chrom, cbind)
sd_pcs_per_chrom <- as_tibble(sd_pcs_per_chrom)
setnames(sd_pcs_per_chrom, colnames(sd_pcs_per_chrom), chroms)


tidy_sd_per_chrom <- sd_pcs_per_chrom %>%
  rownames_to_column("PCs") %>%
  pivot_longer(2:6, names_to = "chrom", values_to = "PCs_sd")

graph_table <- all_chrom_pcs1e2 %>%
  inner_join(pop_info, by = "population") %>%  #joins tables
  mutate(collection_year = case_when( #treats collection_year as character
    collection_year == 1997 ~ "1997", 
    collection_year == 2009 ~ "2009/2010", #and join 2009 and 2010
    collection_year == 2010 ~ "2009/2010",
    collection_year == 2017 ~ "2017"
  )) %>%
  pivot_longer(cols = 2:11, names_to = "PCs",
               values_to = "var") %>%
  separate(col = PCs, into = c("PC", "chrom"), sep = "_") %>%
  pivot_wider(names_from = PC, values_from = var)


graph_table %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(aes(color = latitude), size = 2, alpha = 0.5) +
  scale_color_viridis_c() +
  geom_text(aes(label = population), size = 1.5, nudge_y = 10) +
  facet_wrap(~ chrom, nrow = 2) +
#xlab(paste("PC1 - ", pca_var_per[1], "%", sep = "")) +
#ylab(paste("PC2 - ", pca_var_per[2], "%", sep = "")) +
theme_bw()

tidy_sd_per_chrom %>%
  mutate(PCs = as.integer(PCs)) %>%
  ggplot() +
  geom_bar(aes(x = PCs, y = PCs_sd), stat = "identity") +
  facet_wrap(~ chrom) +
  labs(x = "PCs", y = "var %")

``` 

### 2009/2010
```{r pca_per_chrom_0910, echo=FALSE, message=FALSE, warning=FALSE}
chroms <- c("2L", "2R", "3L", "3R", "X")

no_NA_table0910[, c("CHROM", "POS") := tstrsplit(position2, ":", fixed = TRUE)]

#separate each chrom
output <- vector("list", length = length(chroms))
for (i in seq_along(chroms)) {
  output[[i]] <- no_NA_table0910[CHROM == chroms[[i]],][, !c("CHROM", "POS")]
}

#pre pca and pca
for (i in seq_along(output)) {
  output[[i]] <- column_to_rownames(output[[i]], var = "position2")
}

for (i in seq_along(output)) {
  output[[i]] <- t(output[[i]])
}

pca_per_chrom <- vector("list", length = length(chroms))
for (i in seq_along(output)) {
  pca_per_chrom[[i]] <- prcomp(output[[i]])
}

#gets pc1 and 2 for each chrom
pcs1e2_per_chrom <- vector("list", length = length(chroms))
for (i in seq_along(pca_per_chrom)) {
  pcs1e2_per_chrom[[i]] <- pca_per_chrom[[i]]$x[,1:2]
}

for (i in seq_along(pcs1e2_per_chrom)) {
  pcs1e2_per_chrom[[i]] <- as.data.frame(pcs1e2_per_chrom[[i]])
}

#change cols names
for (i in seq_along(pcs1e2_per_chrom)) {
  pcs1e2_per_chrom[[i]] <- setnames(pcs1e2_per_chrom[[i]],
                                    colnames(pcs1e2_per_chrom[[i]]),
                                    paste(colnames(pcs1e2_per_chrom[[i]]), chroms[[i]], sep = "_"))
}

all_chrom_pcs1e2 <- reduce(pcs1e2_per_chrom, cbind) %>%
  rownames_to_column("population")

#gets sdv per chrom
sdv_per_chrom <- vector("list", length = length(pca_per_chrom))
for (i in seq_along(pca_per_chrom)) {
  sdv_per_chrom[[i]] <- (pca_per_chrom[[i]]$sdev)^2
}

for (i in seq_along(sdv_per_chrom)) {
  sdv_per_chrom[[i]] <- round((sdv_per_chrom[[i]]/sum(sdv_per_chrom[[i]]))*100, 1)
}

sd_pcs_per_chrom <- reduce(sdv_per_chrom, cbind)
sd_pcs_per_chrom <- as_tibble(sd_pcs_per_chrom)
setnames(sd_pcs_per_chrom, colnames(sd_pcs_per_chrom), chroms)


tidy_sd_per_chrom <- sd_pcs_per_chrom %>%
  rownames_to_column("PCs") %>%
  pivot_longer(2:6, names_to = "chrom", values_to = "PCs_sd")

graph_table <- all_chrom_pcs1e2 %>%
  inner_join(pop_info, by = "population") %>%  #joins tables
  mutate(collection_year = case_when( #treats collection_year as character
    collection_year == 1997 ~ "1997", 
    collection_year == 2009 ~ "2009/2010", #and join 2009 and 2010
    collection_year == 2010 ~ "2009/2010",
    collection_year == 2017 ~ "2017"
  )) %>%
  pivot_longer(cols = 2:11, names_to = "PCs",
               values_to = "var") %>%
  separate(col = PCs, into = c("PC", "chrom"), sep = "_") %>%
  pivot_wider(names_from = PC, values_from = var)


graph_table %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(aes(color = latitude), size = 2, alpha = 0.5) +
  scale_color_viridis_c() +
  geom_text(aes(label = population), size = 1.5, nudge_y = 10) +
  facet_wrap(~ chrom, nrow = 2) +
#xlab(paste("PC1 - ", pca_var_per[1], "%", sep = "")) +
#ylab(paste("PC2 - ", pca_var_per[2], "%", sep = "")) +
theme_bw()

tidy_sd_per_chrom %>%
  mutate(PCs = as.integer(PCs)) %>%
  ggplot() +
  geom_bar(aes(x = PCs, y = PCs_sd), stat = "identity") +
  facet_wrap(~ chrom) +
  labs(x = "PCs", y = "var %")

``` 

## Inversions

```{r, echo=FALSE, message=FALSE, warning=FALSE}
inv_freq <- melt.data.table(inv_freq, measure.vars =  2:14,
                            variable.name = "population",
                            value.name = "freq")

complete <- inv_freq %>%
  inner_join(pop_info, by = "population") %>%
  mutate(collection_year = case_when( #treats collection_year as character
    collection_year == 1997 ~ "1997", 
    collection_year == 2009 ~ "2009/2010", #and join 2009 and 2010
    collection_year == 2010 ~ "2009/2010",
    collection_year == 2017 ~ "2017"
  ))
complete %>%
  filter(collection_year != "2017") %>%
  ggplot(aes(x = latitude, y = freq)) +
  geom_point(aes(color = collection_year), alpha = 0.5) +
  geom_smooth(aes(color = collection_year), method = 'lm', alpha = 0.2) +
  geom_text(aes(label = population), size = 1.5, nudge_y = 0.07) +
  facet_wrap(~ Inv, nrow = 3) +
  theme_light() +
  labs(title = "Inversions Frequencies") +
  scale_fill_discrete(name = "Collection Year")

```

## Manhattan Plots
```{r manhattan_97, echo=FALSE}
SNPs_97_cov15[, c("CHROM", "POS") := tstrsplit(position2, ":", fixed = TRUE)]

SNPs_97_cov15 <- SNPs_97_cov15[, .(CHROM, POS, p_value)]
SNPs_97_cov15[, POS := as.double(POS)]
setkey(SNPs_97_cov15, CHROM)
SNPs_97_cov15[, ID := .I]

axisdf <-  SNPs_97_cov15 %>% group_by(CHROM) %>% summarize(center=(max(ID) + min(ID)) / 2 )

#get FDR cutof
Pvalue_97_cov15 <- SNPs_97_cov15$p_value
qobj_97_cov15 <- qvalue(p = Pvalue_97_cov15)

#cutoff 0.1%
p_value_cutoff_0.1 <- max(qobj_97_cov15$pvalues[qobj_97_cov15$qvalues <= 0.1])

#cutoff 0.01%
p_value_cutoff_0.01 <- max(qobj_97_cov15$pvalues[qobj_97_cov15$qvalues <= 0.01])

#cutoff 0.05%
p_value_cutoff_0.005 <- max(qobj_97_cov15$pvalues[qobj_97_cov15$qvalues <= 0.005])

#manhattan plot manual

SNPs_97_cov15 %>%
  ggplot(aes(x = ID, y =-log10(p_value))) +
  geom_point(aes(color=as.factor(CHROM)), alpha=0.8, size=0.9) +
  geom_line(aes(y = -log10(p_value_cutoff_0.1)), color = "green") +
  geom_line(aes(y = -log10(p_value_cutoff_0.01)), color = "blue") +
  geom_line(aes(y = -log10(p_value_cutoff_0.005)), color = "red") +
  geom_text(aes(x = max(ID)+10,
                y = -log10(p_value_cutoff_0.1) + 0.25,
                label = "FDR 10%"),
            size = 2.5, color = "green") +
  geom_text(aes(x = max(ID)+10,
                y = -log10(p_value_cutoff_0.01) + 0.25,
                label = "FDR 1%"),
            size = 2.5, color = "blue") +
  geom_text(aes(x = max(ID)+10,
                y = -log10(p_value_cutoff_0.005) + 0.25,
                label = "FDR 0.5%"),
            size = 2.5, color = "red") +
  scale_color_manual(values = rep(c("lavender", "lavenderblush1"), 5)) +
  scale_x_continuous(label = axisdf$CHROM, breaks= axisdf$center) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme( 
    legend.position="none",
    panel.border = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  ) + 
  labs(title = "1997", y = "-log10(p-value)")

```

```{r manhattan_0910, echo=FALSE}
SNPs_0910_cov15[, c("CHROM", "POS") := tstrsplit(position2, ":", fixed = TRUE)]

SNPs_0910_cov15 <- SNPs_0910_cov15[, .(CHROM, POS, p_value)]
SNPs_0910_cov15[, POS := as.double(POS)]
setkey(SNPs_0910_cov15, CHROM)
SNPs_0910_cov15[, ID := .I]

axisdf <-  SNPs_0910_cov15 %>% group_by(CHROM) %>% summarize(center=( max(ID) + min(ID) ) / 2 )

#get FDR cutof
Pvalue_0910_cov15 <- SNPs_0910_cov15$p_value
qobj_0910_cov15 <- qvalue(p = Pvalue_0910_cov15)

#cutoff 0.1%
p_value_cutoff_0.1 <- max(qobj_0910_cov15$pvalues[qobj_0910_cov15$qvalues <= 0.1])

#cutoff 0.01%
p_value_cutoff_0.01 <- max(qobj_0910_cov15$pvalues[qobj_0910_cov15$qvalues <= 0.01])

#cutoff 0.05%
p_value_cutoff_0.005 <- max(qobj_0910_cov15$pvalues[qobj_0910_cov15$qvalues <= 0.005])

#manhattan plot manual

SNPs_0910_cov15 %>%
  ggplot(aes(x = ID, y =-log10(p_value))) +
  geom_point(aes(color=as.factor(CHROM)), alpha=0.8, size=0.9) +
  geom_line(aes(y = -log10(p_value_cutoff_0.1)), color = "green") +
  geom_line(aes(y = -log10(p_value_cutoff_0.01)), color = "blue") +
  geom_line(aes(y = -log10(p_value_cutoff_0.005)), color = "red") +
  geom_text(aes(x = max(ID)+10,
                y = -log10(p_value_cutoff_0.1) + 0.25,
                label = "FDR 10%"),
            size = 2.5, color = "green") +
  geom_text(aes(x = max(ID)+10,
                y = -log10(p_value_cutoff_0.01) + 0.25,
                label = "FDR 1%"),
            size = 2.5, color = "blue") +
  geom_text(aes(x = max(ID)+10,
                y = -log10(p_value_cutoff_0.005) + 0.25,
                label = "FDR 0.5%"),
            size = 2.5, color = "red") +
  scale_color_manual(values = rep(c("lavender", "lavenderblush1"), 5)) +
  scale_x_continuous(label = axisdf$CHROM, breaks= axisdf$center) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() +
  theme( 
    legend.position="none",
    panel.border = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  ) + 
  labs(title = "2009/2010", y = "-log10(p-value)")
```
