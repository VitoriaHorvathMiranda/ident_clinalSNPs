---
title: "Quem são os SNPs com p-valores altos?"
author: "Vitória"
date: '2023-04-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
```
## Quem são os SNPs com p-valores altos?

Conforme descrito no [primeiro relatório](https://github.com/VitoriaHorvathMiranda/ident_clinalSNPs/blob/main/relatorio_clinalSNP_ident.md), exitem muitos p-valores muito altos do primeiro call (aquele cuja a frequencia global mínima era de 0.5%). Quando fiz o segundo call, com frequência global mínima de 1%, a situação melhorou um pouco. Mas ainda era possível observar muitos p-valores muito altos. 

Eu queria entender melhor quem eram esses SNPs com p-valores tão altos. Como o call era feito com todas populações juntas, independente do ano de amostra, esperavamos que a maioria desses SNPs representassem SNPs presentes em um período mas não no outro. Assim, no período no qual ele não estivesse presente, todas as populações amostradas teriam frequência igual a zero. Essa série de zeros claramente geraria p-valores muito altos. Visto isso, resolvi filtrar os SNPs cuja a frequência era igual a zero em todas as populações de cada uma das épocas amostradas (não tinha pensado em como fazer isso antes). Depois de filtrar esses SNPs, eu refiz os histogramas dos p-valores:

```{r data, echo=FALSE}
p_value_97_cov10 <- fread("/dados/time_clines/output/SNPs/p-values_97_mincount5_minfreq0.005_cov10.tsv")
NE_table <- fread("/dados/time_clines/output/SNPs/joined97_mincount5_minfreq0.005_cov10.tsv")

p_value_0910_cov10 <- fread("/dados/time_clines/output/SNPs/p-values_0910_mincount5_minfreq0.005_cov10.tsv")
NE_table_0910 <- fread("/dados/time_clines/output/SNPs/joined0910_mincount5_minfreq0.005_cov10.tsv")

```
```{r no_freq0_setup_plots, echo=FALSE, message=FALSE}
NE_table[, position2 := paste(CHROM, POS, sep = ":")]
NE_table_0910[, position2 := paste(CHROM, POS, sep = ":")]
NE_table[, freq_status := 1*(freq!= 0)]
NE_table_0910[, freq_status := 1*(freq!= 0)]

freq0_97 <- NE_table[, .(freq_status_sum = sum(freq_status)),
                           by = "position2"][freq_status_sum ==0,]

freq0_0910 <- NE_table_0910[, .(freq_status_sum = sum(freq_status)),
                           by = "position2"][freq_status_sum ==0,]

p_value_97_no_freq0 <- p_value_97_cov10[!freq0_97, on = "position2"]

p_value_0910_no_freq0 <- p_value_0910_cov10[!freq0_0910, on = "position2"]

p_value_97_no_freq0 %>%
  ggplot() +
  geom_histogram(aes(p_value))+
  labs(x = "p-value", title = "1997",
       caption = "min-freq = 0.005, min-cov = 10, min-count = 5") +
  theme_minimal()

p_value_0910_no_freq0 %>%
  ggplot() +
  geom_histogram(aes(p_value))+
  labs(x = "p-value", title = "2009/2010",
       caption = "min-freq = 0.005, min-cov = 10, min-count = 5") +
  theme_minimal()

```

Embora a maioria dos p-valores altos desapareça depois desse filtro, ainda é possível ver o pico no extremo do gráfico. Então resolvi filtrar todos os SNPs cuja a frequência só era diferente de zero em uma população de um determinado período, ou seja, removi todos os SNPs unicos de uma determinada população. Quando fiz isso, os p-valores altos desaparesceram:

```{r no_unique, echo=FALSE, message=FALSE}
unique_97 <- NE_table[, .(freq_status_sum = sum(freq_status)),
                           by = "position2"][freq_status_sum ==1,]

unique_0910 <- NE_table_0910[, .(freq_status_sum = sum(freq_status)),
                           by = "position2"][freq_status_sum ==1,]

p_value_97_no_unique <- p_value_97_no_freq0[!unique_97, on = "position2"]

p_value_0910_no_unique <- p_value_0910_no_freq0[!unique_0910, on = "position2"]

p_value_97_no_unique %>%
  ggplot() +
  geom_histogram(aes(p_value))+
  labs(x = "p-value", title = "1997",
       caption = "min-freq = 0.005, min-cov = 10, min-count = 5") +
  theme_minimal()

p_value_0910_no_unique%>%
  ggplot() +
  geom_histogram(aes(p_value))+
  labs(x = "p-value", title = "2009/2010",
       caption = "min-freq = 0.005, min-cov = 10, min-count = 5") +
  theme_minimal()
```

Dá para ver que a forma do histograma de 2009/2010 muda um pouco, acho que isso ocorre quando esses SNPs únicos estão presentes em populações nos extremos latitudinais. O histograma com apenas os SNPs removidos fica assim:
```{r echo=FALSE, message=FALSE}
p_value_97_only_unique <- p_value_97_cov10[unique_97, on = "position2"]

p_value_97_only_unique %>%
  ggplot() +
  geom_histogram(aes(p_value))+
  labs(x = "p-value", title = "1997 _unique",
       caption = "min-freq = 0.005, min-cov = 10, min-count = 5") +
  theme_minimal()

p_value_0910_only_unique <- p_value_0910_cov10[unique_0910, on = "position2"]

p_value_0910_only_unique %>%
  ggplot() +
  geom_histogram(aes(p_value))+
  labs(x = "p-value", title = "2009/2010 _unique",
       caption = "min-freq = 0.005, min-cov = 10, min-count = 5") +
  theme_minimal()

```

Como o segundo call (com frequência mínima de 1%) não havia removido completamente esse pico de SNPs altos, imaginei que pelo menos alguns deles tivessem frequências altas nas populações onde ocorrem, e aparentemente isso realmente ocorre:
```{r unique_freqs, echo=FALSE, message=FALSE}
unique_NE <- NE_table[unique_97, on = "position2"]
unique_NE %>%
  ggplot() +
  geom_histogram(aes(freq)) +
  labs(title = "1997")

unique_NE_0910 <- NE_table_0910[unique_0910, on = "position2"]
unique_NE_0910 %>%
  ggplot() +
  geom_histogram(aes(freq)) +
  labs(titble = "1997") +
  labs(title = "2009/2010")

```

No final, dá para perceber que o pico de p-valores é causado principalmente pelos SNPs que parecem em apenas uma população:

```{r snp_dist, echo=FALSE, message=FALSE}
dist_unique <- tibble(snps = c("total", "zero_pops", "one_pop"),
       Y_1997 = c(187259+297701, 187259, 297701),
       Y_2009_2010 = c(28625+173978, 28625, 173978))

tidy_dist_unique <- dist_unique %>%
  pivot_longer(cols = c(Y_1997, Y_2009_2010), 
               names_to = "year",
               values_to = "n_snps")


tidy_dist_unique %>%
  filter(snps != "total") %>%
  ggplot(aes(x = year, y = n_snps)) +
  geom_bar(aes(fill = snps), stat = "identity", alpha = 0.6) +
  scale_fill_discrete(labels = c("one_pop" = "one population only",
                                 "zero_pops" = "not present in that period")) +
  labs(y = "nº of snps") +
  scale_x_discrete(labels = c("1997", "2009/2010")) +
  theme_bw()
  
```

Dos SNPs presentes em apenas uma população, 49.722 estão presentes em ambos os períodos, mas desses, apenas 21.776 aparecem na mesma região geográfica. Como a maioria das coletas não ocorrem exatamente nos mesmos pontos nos dois períodos, separei os pontos de coleta em três grupos em relação a latitude. Latitude baixa, menor que 30; média, entre 30 e 40; e alta, maior que 40. Dos 21.776 SNPs únicos que aparecem na mesma região, 891 tiveram uma mudança de frequência maior que 0.2. 




